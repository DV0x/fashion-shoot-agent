# Session Summary - January 4, 2026

## Overview

Debugging session focused on checkpoint detection improvements and resolving a critical crop-frames.ts grid detection failure caused by corrupted node_modules.

---

## Issues Addressed

### 1. Missing Checkpoint Detection for Frame Regeneration

**Problem:** When users requested modifications to individual frames (e.g., "give frames 3 and 4 gangster poses"), the PostToolUse hooks failed to detect a checkpoint. The hook-based detection only triggered for:
- `generate-image.ts` → `outputs/hero.png` (hero checkpoint)
- `crop-frames.ts` → `frame-6.png` (frames checkpoint)
- `resize-frames.ts` → `"success": true` (frames checkpoint)

But NOT for `generate-image.ts` → `outputs/frames/frame-*.png` (individual frame regeneration).

**Evidence from output.md (lines 342-348):**
```
hookCheckpoint: null                    ← Should NOT be null
parsedCheckpoint: {"status":"complete","message":""}
detectedCheckpoints map size: 0         ← Map is empty
```

**Solution:** Added new detection rule in `server/lib/ai-client.ts` (lines 47-74):

```typescript
// Detect individual frame regeneration (from generate-image.ts to outputs/frames/)
if (command.includes('generate-image.ts') && output.includes('outputs/frames/frame-')) {
  const frameMatches = output.match(/outputs\/frames\/frame-(\d+)\.png/g);
  const regeneratedFrames = frameMatches ? [...new Set(frameMatches)].sort() : [];
  const frameNumbers = regeneratedFrames.map(f => f.match(/frame-(\d+)/)?.[1]).filter(Boolean);
  const frameList = frameNumbers.length > 1
    ? `Frames ${frameNumbers.join(', ')} regenerated.`
    : `Frame ${frameNumbers[0]} regenerated.`;

  return {
    stage: 'frames',
    status: 'complete',
    artifacts: ['outputs/frames/frame-1.png', ...],
    message: `${frameList} Reply "continue" or request more changes.`
  };
}
```

**Files Modified:**
- `server/lib/ai-client.ts` - Added detection rule
- `docs/ARCHITECTURE.md` - Updated detection rules table

---

### 2. Contact Sheet Frames Cropped as Portrait (9:16) Instead of Square

**Initial Observation:** Frames were being cropped at 392×838 (portrait) instead of expected ~843×848 (square).

**Investigation Path:**

1. **Checked contact sheet dimensions:**
   ```bash
   ffprobe outputs/contact-sheet.png
   # Result: 2528×1696 (3:2 landscape) ✓
   ```

2. **Analyzed crop-frames.ts output:**
   ```
   cellWidth: 392
   cellHeight: 838
   gutterX: 675   ← Suspiciously large!
   ```

3. **Ran crop-frames.ts with debug output:**
   ```
   Found 3 vertical peaks: 505, 1282, 2009  ← Wrong peaks!
   ```

   Expected peaks for 3-column grid: ~843, ~1686
   Detected peaks (505, 1282, 2009) were subject silhouette edges, not frame boundaries.

4. **Checked git history:**
   - `6387b26` - Original script (simple mathematical division)
   - `de9f226` - Added hybrid grid detection (OpenCV edge detection)
   - OpenCV.js was added to package.json AFTER hybrid detection was written

**Root Cause:** Corrupted node_modules causing OpenCV.js to behave incorrectly.

**Solution:** Clean reinstall of packages:
```bash
rm -rf node_modules package-lock.json && npm install
```

**Result After Fix:**
```
Found 2 vertical peaks: 843, 1684  ← Correct!
Cell size: 842×848 (square) ✓
```

---

### 3. Slight Gutters Visible in Cropped Frames

**Observation:** After fixing the detection, frames showed slight gutter margins on edges.

**Investigation:**
- Algorithm detected: 636×769 cells with 206px horizontal gutters
- Simple math crop (842×848): Looked terrible - content was cut off
- Wider crop test (650×769): Worse than algorithm detection

**Conclusion:** Not a script issue. The contact sheet generated by FAL has actual visible gutters/margins between frames. The algorithm correctly detected these boundaries.

**Possible Future Fix:** Update contact-sheet prompt to request edge-to-edge frames from FAL.

---

## Package Health Check

After clean reinstall:

| Check | Status |
|-------|--------|
| Vulnerabilities | 0 found |
| Peer dependencies | No issues |
| Missing deps | None |

**Outdated packages (major versions - do not auto-update):**
- express: 4.22.1 → 5.2.1
- zod: 3.25.76 → 4.3.4
- @types/node: 20.x → 25.x
- @types/express: 4.x → 5.x

---

## Key Learnings

### 1. Corrupted node_modules Can Cause Subtle Bugs
OpenCV.js with corrupted installation detected wrong edge peaks (content edges instead of frame boundaries). Same code, same version number, but different behavior. **Always try clean reinstall when behavior is inconsistent.**

### 2. Hybrid Detection vs Mathematical Division
The hybrid grid detection in crop-frames.ts works when:
- Contact sheets have visible gutter lines
- OpenCV.js is properly installed

Falls back incorrectly when:
- No visible gutters exist
- OpenCV detects content edges instead

**Recommendation:** Consider adding a sanity check fallback when detected gutter > 30% of expected cell width.

### 3. Checkpoint Detection Completeness
The PostToolUse hooks need to cover ALL paths that create artifacts:
- Initial creation (crop-frames.ts)
- Resize (resize-frames.ts)
- **Regeneration (generate-image.ts → frames/)** ← Was missing

---

## Files Modified This Session

| File | Change |
|------|--------|
| `server/lib/ai-client.ts` | Added frame regeneration checkpoint detection |
| `docs/ARCHITECTURE.md` | Updated checkpoint detection rules table |
| `package-lock.json` | Regenerated after clean install |
| `node_modules/` | Clean reinstalled |

---

## Test Commands Used

```bash
# Check contact sheet dimensions
ffprobe -v error -select_streams v:0 -show_entries stream=width,height -of csv=p=0 outputs/contact-sheet.png

# Run crop-frames with debug output
npx tsx .claude/skills/fashion-shoot-pipeline/scripts/crop-frames.ts \
  --input outputs/contact-sheet.png \
  --output-dir /tmp/test-frames/ \
  --rows 2 --cols 3

# Clean reinstall packages
rm -rf node_modules package-lock.json && npm install

# Check package health
npm audit
npm outdated
npm ls
```

---

## Session Duration
~45 minutes

## Outcome
- Frame regeneration checkpoint detection: **Fixed**
- Crop-frames grid detection: **Fixed** (was corrupted packages)
- Slight gutter margins: **Not a bug** (FAL output characteristic)
- Package health: **Clean**
